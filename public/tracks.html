<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tracks ‚Äî TYNDA</title>
  <meta name="description" content="Browse and manage music tracks on TYNDA">
  <link rel="stylesheet" href="/style.css">
</head>

<body>
  <header class="topbar">
    <div class="container topbar-inner">
      <a class="brand" href="/">TYNDA</a>
      <nav class="nav">
        <a href="/">Home</a>
        <a href="/about">About</a>
        <a href="/contact">Contact</a>
        <a class="active" href="/tracks">Tracks</a>
        <a href="/playlists">Playlists</a>
        <div class="nav-auth" id="nav-auth">
          <!-- Auth buttons injected by JS -->
        </div>
      </nav>
    </div>
  </header>

  <main class="container">
    <div
      style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-wrap: wrap; gap: 16px;">
      <div>
        <h1>Music Tracks</h1>
        <p class="muted" id="tracks-status">Loading...</p>
      </div>
      <div id="auth-notice" class="hidden"
        style="padding: 12px 20px; background: rgba(245,158,11,0.1); border: 1px solid rgba(245,158,11,0.3); border-radius: var(--radius); font-size: 0.9rem;">
        üîí <a href="/login">Login</a> to create, edit, or delete tracks
      </div>
    </div>

    <div class="grid grid-tracks-layout">
      <!-- Tracks List -->
      <section class="card">
        <div class="card-head">
          <h2>All Tracks</h2>
        </div>

        <!-- Filters -->
        <div class="filters-panel">
          <div class="filters-row">
            <input type="text" id="search-input" placeholder="Search by artist name..." oninput="loadTracks()">
            <select id="sort-select" onchange="loadTracks()">
              <option value="">Sort: Default</option>
              <option value="title">A-Z (Title)</option>
              <option value="artist">A-Z (Artist)</option>
              <option value="date">Newest First</option>
            </select>
          </div>

          <div class="filters-row">
            <span class="projection-title">Show Columns:</span>
            <label class="custom-checkbox">
              <input type="checkbox" id="proj-artist" checked onchange="loadTracks()">
              <span class="checkmark"></span>
              Artist
            </label>
            <label class="custom-checkbox">
              <input type="checkbox" id="proj-album" checked onchange="loadTracks()">
              <span class="checkmark"></span>
              Album
            </label>
            <label class="custom-checkbox">
              <input type="checkbox" id="proj-genre" checked onchange="loadTracks()">
              <span class="checkmark"></span>
              Genre
            </label>
            <label class="custom-checkbox">
              <input type="checkbox" id="proj-dur" checked onchange="loadTracks()">
              <span class="checkmark"></span>
              Duration
            </label>
          </div>
        </div>

        <!-- Table -->
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Title</th>
                <th id="th-artist">Artist</th>
                <th id="th-album">Album</th>
                <th id="th-genre">Genre</th>
                <th id="th-dur">Duration</th>
                <th id="th-actions" style="text-align: right;">Actions</th>
              </tr>
            </thead>
            <tbody id="tracks-body"></tbody>
          </table>
        </div>

        <!-- Pagination Controls -->
        <div class="pagination-controls" id="pagination-controls"
          style="display: flex; justify-content: center; align-items: center; gap: 16px; padding: 20px; margin-top: 16px; border-top: 1px solid rgba(255,255,255,0.1);">
          <button class="btn btn-ghost btn-sm" id="prev-page" onclick="changePage(-1)" disabled>‚Üê Previous</button>
          <span id="page-info" class="muted">Page 1 of 1</span>
          <button class="btn btn-ghost btn-sm" id="next-page" onclick="changePage(1)" disabled>Next ‚Üí</button>
        </div>
      </section>

      <!-- Create/Edit Form -->
      <section class="card" id="form-section" style="position: sticky; top: 90px;">
        <div class="card-head">
          <h2 id="form-title">Create Track</h2>
        </div>

        <div id="form-auth-notice" class="hidden"
          style="padding: 16px; background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.3); border-radius: var(--radius); margin-bottom: 20px; text-align: center;">
          <p style="margin: 0 0 12px 0;">You must be logged in to manage tracks</p>
          <a href="/login" class="btn btn-sm">Sign In</a>
        </div>

        <form id="track-form" class="form">
          <input type="hidden" id="track-id">

          <div class="field">
            <label for="track-title">Title *</label>
            <input type="text" id="track-title" placeholder="Track name" required>
          </div>

          <div class="field">
            <label for="track-artist">Artist *</label>
            <input type="text" id="track-artist" placeholder="Performer name" required>
          </div>

          <div class="form-grid">
            <div class="field">
              <label for="track-album">Album</label>
              <input type="text" id="track-album" placeholder="Album title">
            </div>
            <div class="field">
              <label for="track-genre">Genre</label>
              <select id="track-genre">
                <option value="Pop">Pop</option>
                <option value="Rock">Rock</option>
                <option value="Hip-Hop">Hip-Hop</option>
                <option value="R&B">R&B</option>
                <option value="Electronic">Electronic</option>
                <option value="Jazz">Jazz</option>
                <option value="Classical">Classical</option>
                <option value="Country">Country</option>
                <option value="Metal">Metal</option>
                <option value="Other" selected>Other</option>
              </select>
            </div>
          </div>

          <div class="form-grid">
            <div class="field">
              <label for="track-duration">Duration (sec)</label>
              <input type="number" id="track-duration" min="0" step="1" placeholder="e.g. 210">
            </div>
            <div class="field">
              <label for="track-year">Release Year</label>
              <input type="number" id="track-year" min="1900" max="2030" placeholder="e.g. 2024">
            </div>
          </div>

          <div class="actions" style="flex-direction: column;">
            <button class="btn" type="submit" id="save-btn" style="width: 100%;">
              <span id="save-btn-text">Save Track</span>
              <span id="save-btn-loading" class="loading-spinner hidden"></span>
            </button>
            <button class="btn btn-ghost" type="button" id="reset-btn" style="width: 100%;">Cancel / Reset</button>
          </div>

          <p class="muted center" id="form-status" style="min-height: 20px; font-size: 0.85rem;"></p>
        </form>
      </section>
    </div>
  </main>

  <footer class="footer">
    <div class="container">
      <p>¬© <span id="year"></span> TYNDA ‚Äî Course Project</p>
    </div>
  </footer>

  <!-- Toast Container -->
  <div id="toast-container" class="toast-container"></div>

  <script>
    document.getElementById('year').textContent = new Date().getFullYear();

    // State
    let isAuthenticated = false;
    let currentUser = null;
    let currentPage = 1;
    let totalPages = 1;
    const ITEMS_PER_PAGE = 10;

    // DOM Elements
    const API_BASE = '/api/tracks';
    const tracksStatusEl = document.getElementById('tracks-status');
    const tracksBodyEl = document.getElementById('tracks-body');
    const form = document.getElementById('track-form');
    const searchInput = document.getElementById('search-input');
    const sortSelect = document.getElementById('sort-select');
    const projArtist = document.getElementById('proj-artist');
    const projAlbum = document.getElementById('proj-album');
    const projGenre = document.getElementById('proj-genre');
    const projDur = document.getElementById('proj-dur');

    const idInput = document.getElementById('track-id');
    const titleInput = document.getElementById('track-title');
    const artistInput = document.getElementById('track-artist');
    const albumInput = document.getElementById('track-album');
    const genreInput = document.getElementById('track-genre');
    const durationInput = document.getElementById('track-duration');
    const yearInput = document.getElementById('track-year');
    const saveBtn = document.getElementById('save-btn');
    const saveBtnText = document.getElementById('save-btn-text');
    const saveBtnLoading = document.getElementById('save-btn-loading');
    const formTitleEl = document.getElementById('form-title');
    const formStatusEl = document.getElementById('form-status');

    // Toast notifications
    function showToast(message, type = 'success') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;

      const icons = { success: '‚úì', error: '‚úï', warning: '‚ö†' };

      toast.innerHTML = `
                <span class="toast-icon">${icons[type] || '‚Ä¢'}</span>
                <span class="toast-message">${message}</span>
                <button class="toast-close" onclick="this.parentElement.remove()">√ó</button>
            `;

      container.appendChild(toast);
      setTimeout(() => toast.remove(), 5000);
    }

    // Format duration
    function formatDuration(seconds) {
      if (!seconds) return '-';
      const mins = Math.floor(seconds / 60);
      const secs = seconds % 60;
      return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    // Check auth status
    async function checkAuth() {
      try {
        const response = await fetch('/api/auth/me');
        const data = await response.json();
        isAuthenticated = data.isAuthenticated;
        currentUser = data.user;
        updateAuthUI();
      } catch (err) {
        console.error('Auth check failed:', err);
      }
    }

    // Update UI based on auth status
    function updateAuthUI() {
      const authContainer = document.getElementById('nav-auth');
      const authNotice = document.getElementById('auth-notice');
      const formAuthNotice = document.getElementById('form-auth-notice');
      const formInputs = form.querySelectorAll('input, select, button[type="submit"]');
      const nav = document.querySelector('.nav');

      if (isAuthenticated) {
        const isAdmin = currentUser.role === 'admin';
        const roleBadge = isAdmin ? '<span class="admin-badge" style="background: linear-gradient(135deg, #f59e0b, #d97706); color: #000; padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; margin-left: 8px;">ADMIN</span>' : '';

        // Add Admin link for admins
        if (isAdmin && !document.getElementById('admin-link')) {
          const adminLink = document.createElement('a');
          adminLink.href = '/admin';
          adminLink.id = 'admin-link';
          adminLink.textContent = 'Admin';
          nav.insertBefore(adminLink, authContainer);
        }

        authContainer.innerHTML = `
                    <span class="user-badge">${currentUser.username}${roleBadge}</span>
                    <button class="btn btn-ghost btn-sm" onclick="logout()">Logout</button>
                `;
        authNotice.classList.add('hidden');
        formAuthNotice.classList.add('hidden');
        formInputs.forEach(input => input.disabled = false);
      } else {
        authContainer.innerHTML = `
                    <a href="/login" class="btn btn-ghost btn-sm">Sign In</a>
                    <a href="/register" class="btn btn-sm">Sign Up</a>
                `;
        authNotice.classList.remove('hidden');
        formAuthNotice.classList.remove('hidden');
        formInputs.forEach(input => input.disabled = true);
      }
    }

    async function logout() {
      try {
        await fetch('/api/auth/logout', { method: 'POST' });
        showToast('Logged out successfully', 'success');
        setTimeout(() => window.location.reload(), 500);
      } catch (err) {
        showToast('Logout failed', 'error');
      }
    }

    // Load tracks
    async function loadTracks() {
      tracksStatusEl.innerHTML = '<span style="color: var(--accent2);">Loading tracks...</span>';
      tracksBodyEl.innerHTML = '<tr><td colspan="7" class="center"><div class="loading-spinner"></div></td></tr>';

      const artistQuery = searchInput.value.trim();
      const sortQuery = sortSelect.value;

      let fields = ['title'];
      if (projArtist.checked) fields.push('artist');
      if (projAlbum.checked) fields.push('album');
      if (projGenre.checked) fields.push('genre');
      if (projDur.checked) fields.push('durationSeconds');

      const fieldsQuery = fields.join(',');

      let url = `${API_BASE}?page=${currentPage}&limit=${ITEMS_PER_PAGE}&`;
      if (artistQuery) url += `artist=${encodeURIComponent(artistQuery)}&`;
      if (sortQuery) url += `sortBy=${sortQuery}&`;
      if (fieldsQuery) url += `fields=${fieldsQuery}`;

      // Update column visibility
      document.getElementById('th-artist').style.display = projArtist.checked ? '' : 'none';
      document.getElementById('th-album').style.display = projAlbum.checked ? '' : 'none';
      document.getElementById('th-genre').style.display = projGenre.checked ? '' : 'none';
      document.getElementById('th-dur').style.display = projDur.checked ? '' : 'none';

      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error('Failed to load tracks');
        const data = await res.json();

        // Handle new paginated response format
        const tracks = data.tracks || data;
        const pagination = data.pagination || { page: 1, totalPages: 1, total: tracks.length };

        // Update pagination state
        currentPage = pagination.page;
        totalPages = pagination.totalPages;
        updatePaginationUI(pagination);

        if (!Array.isArray(tracks) || tracks.length === 0) {
          tracksStatusEl.textContent = 'No tracks found';
          tracksBodyEl.innerHTML = '<tr><td colspan="7" class="center muted" style="padding: 40px;">No tracks match your criteria</td></tr>';
          return;
        }

        tracksStatusEl.textContent = `Showing ${tracks.length} of ${pagination.total} track${pagination.total !== 1 ? 's' : ''} (Page ${pagination.page}/${pagination.totalPages})`;
        tracksBodyEl.innerHTML = '';

        const isAdmin = currentUser && currentUser.role === 'admin';

        tracks.forEach((track) => {
          const tr = document.createElement('tr');
          const shortId = track._id.slice(-6);

          // Check if current user owns this track
          const isOwner = currentUser && track.createdBy && track.createdBy.toString() === currentUser.id;
          const canEdit = isAuthenticated && (isOwner || isAdmin);

          // Ownership indicator
          const ownerBadge = isOwner ? '<span style="color: #10b981; font-size: 0.7rem; margin-left: 4px;" title="Your track">‚òÖ</span>' : '';

          const showArtist = track.artist !== undefined ? track.artist : '<span class="muted">‚Äî</span>';
          const showAlbum = track.album !== undefined ? (track.album || '‚Äî') : '<span class="muted">‚Äî</span>';
          const showGenre = track.genre !== undefined ? track.genre : '<span class="muted">‚Äî</span>';
          const showDur = track.durationSeconds !== undefined ? formatDuration(track.durationSeconds) : '<span class="muted">‚Äî</span>';

          tr.innerHTML = `
                        <td><span class="track-id">...${shortId}</span></td>
                        <td><span class="track-title">${track.title}${ownerBadge}</span></td>
                        <td style="display: ${projArtist.checked ? '' : 'none'};">${showArtist}</td>
                        <td style="display: ${projAlbum.checked ? '' : 'none'};" class="muted">${showAlbum}</td>
                        <td style="display: ${projGenre.checked ? '' : 'none'};"><span class="badge">${showGenre}</span></td>
                        <td style="display: ${projDur.checked ? '' : 'none'};" class="muted">${showDur}</td>
                        <td style="text-align: right;">
                            <div class="flex gap-sm" style="justify-content: flex-end;">
                                ${canEdit ? `
                                    <button class="btn btn-ghost btn-sm" onclick="editTrack('${track._id}')">Edit</button>
                                    <button class="btn btn-danger btn-sm" onclick="deleteTrack('${track._id}')">Delete</button>
                                ` : ''}
                            </div>
                        </td>
                    `;
          tracksBodyEl.appendChild(tr);
        });
      } catch (err) {
        console.error(err);
        tracksStatusEl.textContent = 'Error loading tracks';
        showToast('Failed to load tracks', 'error');
      }
    }

    // Update pagination UI
    function updatePaginationUI(pagination) {
      const prevBtn = document.getElementById('prev-page');
      const nextBtn = document.getElementById('next-page');
      const pageInfo = document.getElementById('page-info');

      prevBtn.disabled = !pagination.hasPrev;
      nextBtn.disabled = !pagination.hasNext;
      pageInfo.textContent = `Page ${pagination.page} of ${pagination.totalPages}`;
    }

    // Change page
    function changePage(direction) {
      const newPage = currentPage + direction;
      if (newPage >= 1 && newPage <= totalPages) {
        currentPage = newPage;
        loadTracks();
      }
    }

    // Reset form
    function resetForm() {
      idInput.value = '';
      titleInput.value = '';
      artistInput.value = '';
      albumInput.value = '';
      genreInput.value = 'Other';
      durationInput.value = '';
      yearInput.value = '';
      formTitleEl.textContent = '‚ûï Create Track';
      saveBtnText.textContent = 'Save Track';
      formStatusEl.textContent = '';
    }

    document.getElementById('reset-btn').addEventListener('click', resetForm);

    // Submit form
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      if (!isAuthenticated) {
        showToast('Please login to manage tracks', 'warning');
        return;
      }

      const id = idInput.value.trim();
      const bodyData = {
        title: titleInput.value.trim(),
        artist: artistInput.value.trim(),
        album: albumInput.value.trim(),
        genre: genreInput.value,
        durationSeconds: durationInput.value ? Number(durationInput.value) : null,
        releaseYear: yearInput.value ? Number(yearInput.value) : null
      };

      saveBtn.disabled = true;
      saveBtnText.textContent = id ? 'Updating...' : 'Creating...';
      saveBtnLoading.classList.remove('hidden');

      try {
        let url = API_BASE;
        let method = 'POST';

        if (id) {
          url = `${API_BASE}/${id}`;
          method = 'PUT';
        }

        const response = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(bodyData)
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Failed to save track');
        }

        showToast(id ? 'Track updated successfully' : 'Track created successfully', 'success');
        resetForm();
        loadTracks();
      } catch (err) {
        formStatusEl.textContent = err.message;
        formStatusEl.style.color = 'var(--error)';
        showToast(err.message, 'error');
      } finally {
        saveBtn.disabled = !isAuthenticated;
        saveBtnText.textContent = 'Save Track';
        saveBtnLoading.classList.add('hidden');
      }
    });

    // Edit track
    async function editTrack(id) {
      if (!isAuthenticated) {
        showToast('Please login to edit tracks', 'warning');
        return;
      }

      try {
        const res = await fetch(`${API_BASE}/${id}`);
        const track = await res.json();

        idInput.value = track._id;
        titleInput.value = track.title || '';
        artistInput.value = track.artist || '';
        albumInput.value = track.album || '';
        genreInput.value = track.genre || 'Other';
        durationInput.value = track.durationSeconds || '';
        yearInput.value = track.releaseYear || '';

        formTitleEl.textContent = '‚úèÔ∏è Edit Track';
        saveBtnText.textContent = 'Update Track';

        document.getElementById('form-section').scrollIntoView({ behavior: 'smooth', block: 'start' });
      } catch (err) {
        console.error(err);
        showToast('Failed to load track data', 'error');
      }
    }

    // Delete track
    async function deleteTrack(id) {
      if (!isAuthenticated) {
        showToast('Please login to delete tracks', 'warning');
        return;
      }

      if (!confirm('Are you sure you want to delete this track?')) return;

      try {
        const response = await fetch(`${API_BASE}/${id}`, { method: 'DELETE' });

        if (!response.ok) {
          const data = await response.json();
          throw new Error(data.error || 'Failed to delete');
        }

        showToast('Track deleted successfully', 'success');
        loadTracks();
      } catch (err) {
        showToast(err.message, 'error');
      }
    }

    // Initialize
    checkAuth().then(() => loadTracks());
  </script>
</body>

</html>